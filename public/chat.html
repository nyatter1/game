<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Lounge | Live Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="n_formatter.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        .chat-container::-webkit-scrollbar {
            width: 5px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 10px;
        }

        .dice-face {
            font-size: 2.5rem;
            line-height: 1;
            margin: 0.5rem 0;
            display: inline-block;
        }

        .dice-anim {
            animation: bounce 0.5s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-slate-950">

    <!-- Header -->
    <header class="glass h-16 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-amber-400 rounded-lg flex items-center justify-center shadow-lg shadow-amber-400/20">
                <span class="text-sm">âœ¨</span>
            </div>
            <h1 class="font-bold tracking-tight text-lg uppercase">VIP <span class="text-amber-400">Lounge</span></h1>
        </div>

        <div class="flex items-center gap-6">
            <div class="hidden sm:flex items-center gap-2 bg-slate-900/50 px-3 py-1.5 rounded-full border border-slate-800">
                <span class="text-amber-400 font-bold text-sm">â‚¿</span>
                <span id="wallet-balance" class="text-slate-200 font-mono text-sm font-bold">0</span>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 cursor-pointer group" onclick="toggleSettings()">
                    <img id="header-pfp" class="w-9 h-9 rounded-full bg-slate-800 border border-slate-700 object-cover" src="" alt="User">
                    <div class="text-left">
                        <p id="header-username" class="text-sm font-bold leading-none"></p>
                        <span id="rank-badge" class="text-[10px] font-black tracking-widest uppercase">VIP MEMBER</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-slate-500 hover:text-rose-500 transition-colors ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Chat Area -->
        <section class="flex-1 flex flex-col relative">
            <div id="chat-feed" class="flex-1 overflow-y-auto p-6 space-y-4 chat-container">
                <!-- Messages arrive here via Socket.io -->
            </div>

            <div class="p-4 glass">
                <form id="chat-form" class="max-w-4xl mx-auto flex gap-2">
                    <input type="text" id="msg-input" autocomplete="off" 
                        class="flex-1 bg-slate-900 border border-slate-800 rounded-2xl px-5 py-3 text-sm focus:outline-none focus:border-amber-500 transition-colors text-white"
                        placeholder="type a message">
                    <button type="submit" class="bg-amber-400 text-amber-950 font-bold px-6 py-3 rounded-2xl hover:bg-amber-300 transition-all active:scale-95">
                        SEND
                    </button>
                </form>
            </div>
        </section>

        <!-- Sidebar -->
        <aside class="hidden md:flex w-64 border-l border-slate-900 flex-col bg-slate-950/50">
            <div class="p-4 border-b border-slate-900">
                <h2 class="text-[10px] font-black text-slate-500 tracking-widest uppercase">Members Online â€” <span id="online-count">0</span></h2>
            </div>
            <div id="online-list" class="flex-1 p-4 space-y-3 overflow-y-auto chat-container"></div>
        </aside>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-[2rem] p-8 border border-slate-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Profile Settings</h3>
                <button onclick="toggleSettings()" class="text-slate-500 hover:text-white">âœ•</button>
            </div>
            <div class="flex flex-col items-center gap-6">
                <div class="relative group cursor-pointer" onclick="document.getElementById('pfp-input').click()">
                    <img id="modal-pfp" class="w-32 h-32 rounded-full border-4 border-amber-400 object-cover bg-slate-800" src="" alt="PFP">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-bold uppercase">Upload</span>
                    </div>
                </div>
                <input type="file" id="pfp-input" class="hidden" accept="image/*" onchange="handlePfpChange(event)">
                <button onclick="saveSettings()" class="w-full bg-amber-400 text-amber-950 font-bold py-4 rounded-xl hover:bg-amber-300 transition-all">
                    SAVE CHANGES
                </button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const DICE_FACES = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
        const DEFAULT_PFP = "https://th.bing.com/th/id/OIP.Qv_L6LKRYVCXksgB6i9m7AHaG1?rs=1&pid=ImgDetMain";
        const VALID_RANKS = ['VIP', 'MOD', 'ADMIN', 'OWNER', 'DEVELOPER'];

        let currentUser = JSON.parse(localStorage.getItem('current_user_session')) || {
            username: 'Guest' + Math.floor(Math.random() * 9999),
            pfp: DEFAULT_PFP,
            balance: 1000,
            rank: 'VIP'
        };

        // Special check for 'dever' account
        if (currentUser.username.toLowerCase() === 'dever') {
            currentUser.rank = 'DEVELOPER';
        }

        // UI Updates
        function updateUI() {
            document.getElementById('header-pfp').src = currentUser.pfp || DEFAULT_PFP;
            document.getElementById('header-username').innerText = currentUser.username;
            document.getElementById('wallet-balance').innerText = nFormatter(currentUser.balance, 1);
            
            const badge = document.getElementById('rank-badge');
            badge.innerText = currentUser.rank;
            badge.className = currentUser.rank === 'DEVELOPER' 
                ? "text-[10px] font-black text-rose-500 tracking-widest uppercase animate-pulse" 
                : "text-[10px] font-black text-amber-500 tracking-widest uppercase";
            
            localStorage.setItem('current_user_session', JSON.stringify(currentUser));
        }

        // Socket Connection
        socket.on('connect', () => {
            socket.emit('join', currentUser);
        });

        socket.on('user_list_update', (users) => {
            document.getElementById('online-count').innerText = users.length;
            document.getElementById('online-list').innerHTML = users.map(u => `
                <div class="flex items-center gap-3">
                    <div class="relative shrink-0">
                        <img src="${u.pfp || DEFAULT_PFP}" class="w-8 h-8 rounded-full object-cover border border-slate-800">
                        <div class="absolute bottom-0 right-0 w-2 h-2 bg-emerald-500 rounded-full border border-slate-950"></div>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold truncate ${u.rank === 'DEVELOPER' ? 'text-rose-400' : 'text-slate-200'}">${u.username}</p>
                        <p class="text-[9px] text-slate-500 uppercase font-black">${u.rank}</p>
                    </div>
                </div>
            `).join('');
        });

        socket.on('chat_message', (msg) => {
            if (msg.type === 'dice') {
                renderDiceVisual(msg);
            } else if (msg.type === 'bank') {
                renderBankVisual(msg);
            } else {
                appendMessage(msg);
            }
        });

        socket.on('system_message', (text) => {
            appendMessage({ username: 'SYSTEM', text: text, rank: 'BOT', pfp: 'https://cdn-icons-png.flaticon.com/512/4712/4712109.png' });
        });

        function appendMessage(msg) {
            const feed = document.getElementById('chat-feed');
            const isMe = msg.username === currentUser.username;
            const isSystem = msg.username === 'SYSTEM';
            
            const div = document.createElement('div');
            div.className = `flex gap-4 group ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <img src="${msg.pfp || DEFAULT_PFP}" class="w-10 h-10 rounded-full object-cover border border-slate-800 shrink-0">
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[80%]">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold ${msg.rank === 'DEVELOPER' ? 'text-rose-400' : 'text-slate-300'}">${msg.username}</span>
                        <span class="text-[9px] border px-1 rounded font-black ${msg.rank === 'DEVELOPER' ? 'border-rose-500 text-rose-500' : 'border-slate-700 text-slate-500'}">${msg.rank}</span>
                    </div>
                    <div class="px-4 py-2.5 rounded-2xl text-sm ${isSystem ? 'bg-slate-900 border border-slate-800 text-slate-400 italic' : (isMe ? 'bg-amber-400 text-amber-950 font-medium' : 'bg-slate-800 text-slate-100')}">
                        ${msg.text}
                    </div>
                </div>
            `;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function renderDiceVisual(msg) {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = 'flex justify-center my-4';
            const won = msg.data.won;
            const color = won ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400' : 'bg-rose-500/10 border-rose-500/50 text-rose-400';
            
            div.innerHTML = `
                <div class="border-2 ${color} p-6 rounded-[2rem] flex flex-col items-center min-w-[260px] glass">
                    <div class="text-5xl mb-2 dice-anim">${DICE_FACES[msg.data.roll - 1]}</div>
                    <p class="text-[10px] uppercase font-black tracking-widest opacity-60">${msg.username} BET ${nFormatter(msg.data.amount)}</p>
                    <p class="text-2xl font-black italic tracking-tighter">${won ? 'JACKPOT!' : 'BUSTED'}</p>
                    ${won ? `<p class="text-xs font-bold mt-1">+${nFormatter(msg.data.payout)} ADDED</p>` : ''}
                </div>
            `;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function renderBankVisual(msg) {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = 'flex justify-center my-4';
            div.innerHTML = `
                <div class="bg-slate-900 border border-slate-800 p-6 rounded-[2.5rem] w-full max-w-[280px] shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-5 text-6xl">ðŸ’°</div>
                    <div class="flex flex-col items-center relative z-10">
                        <img src="${msg.pfp}" class="w-16 h-16 rounded-2xl border-2 border-amber-400 mb-3 object-cover shadow-lg">
                        <h4 class="text-[10px] font-black tracking-[0.2em] text-slate-500 mb-4">${msg.username.toUpperCase()}'S VAULT</h4>
                        <div class="w-full bg-slate-950/50 rounded-2xl p-4 border border-slate-800">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-400">BALANCE</span>
                                <span class="text-lg font-mono font-black text-amber-400">â‚¿ ${nFormatter(msg.balance)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // COMMAND LOGIC
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            const args = text.split(' ');
            const cmd = args[0].toLowerCase();

            // 1. /DICE [amount]
            if (cmd === '/dice') {
                const amount = parseInt(args[1]);
                handleBet(amount);
                input.value = ''; return;
            }

            // 2. /ALLIN
            if (cmd === '/allin') {
                handleBet(currentUser.balance);
                input.value = ''; return;
            }

            // 3. /BANK [user?]
            if (cmd === '/bank') {
                socket.emit('chat_message', { ...currentUser, type: 'bank' });
                input.value = ''; return;
            }

            // 4. /CHANGEUSER [newname]
            if (cmd === '/changeuser') {
                const newName = args[1];
                if (!newName || newName.length < 3) {
                    appendMessage({ username: 'SYSTEM', text: 'Error: Name too short.', rank: 'BOT' });
                } else {
                    currentUser.username = newName;
                    if (newName.toLowerCase() === 'dever') currentUser.rank = 'DEVELOPER';
                    updateUI();
                    socket.emit('join', currentUser);
                    appendMessage({ username: 'SYSTEM', text: `Username updated to ${newName}`, rank: 'BOT' });
                }
                input.value = ''; return;
            }

            // 5. /RANK [user] [rank] (DEVELOPER ONLY)
            if (cmd === '/rank') {
                if (currentUser.rank !== 'DEVELOPER') {
                    appendMessage({ username: 'SYSTEM', text: 'Permision Denied: Developers only.', rank: 'BOT' });
                } else {
                    const target = args[1];
                    const newRank = args[2]?.toUpperCase();
                    if (target && VALID_RANKS.includes(newRank)) {
                        socket.emit('system_message', `ADMIN: ${target} has been promoted to ${newRank}`);
                    } else {
                        appendMessage({ username: 'SYSTEM', text: 'Usage: /rank [user] [VIP/MOD/ADMIN/OWNER/DEVELOPER]', rank: 'BOT' });
                    }
                }
                input.value = ''; return;
            }

            // Default Chat
            socket.emit('chat_message', { ...currentUser, text: text, type: 'text' });
            input.value = '';
        });

        function handleBet(amount) {
            if (isNaN(amount) || amount <= 0) {
                appendMessage({ username: 'SYSTEM', text: 'Usage: /dice [amount] or /allin', rank: 'BOT' });
                return;
            }
            if (amount > currentUser.balance) {
                appendMessage({ username: 'SYSTEM', text: 'Insufficient balance!', rank: 'BOT' });
                return;
            }

            // Developer luck: Always win / Higher win rate
            let winChance = currentUser.rank === 'DEVELOPER' ? 0.95 : 0.48;
            let win = Math.random() < winChance;
            let roll = win ? Math.floor(Math.random() * 3) + 4 : Math.floor(Math.random() * 3) + 1;
            
            const payout = win ? amount : -amount;
            currentUser.balance += payout;
            updateUI();

            socket.emit('chat_message', { 
                ...currentUser, 
                type: 'dice', 
                data: { roll, won: win, amount, payout: amount * 2 } 
            });
        }

        // Settings
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            document.getElementById('modal-pfp').src = currentUser.pfp || DEFAULT_PFP;
        }

        function handlePfpChange(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentUser.pfp = event.target.result;
                    document.getElementById('modal-pfp').src = currentUser.pfp;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveSettings() {
            updateUI();
            socket.emit('join', currentUser); 
            toggleSettings();
        }

        function logout() {
            localStorage.removeItem('current_user_session');
            window.location.href = '/';
        }

        updateUI();
    </script>
</body>
</html>
