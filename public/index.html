<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura | Welcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600&family=Playfair+Display:ital@0;1&family=Space+Mono&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,300&family=Inter:wght@300;600&family=Montserrat:wght@300;700&family=Baskervville:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            overflow: hidden;
            margin: 0;
        }
        .bg-gradient {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at top left, #1a1a1a, #0a0a0a);
            z-index: -1;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.08);
            outline: none;
        }
        .btn-primary {
            background: #ffffff;
            color: #000000;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .fade-in { animation: fadeIn 0.8s ease forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden-state { display: none !important; }

        #loadingScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #loadingScreen.active { opacity: 1; pointer-events: auto; }
        .aura-logo-loading {
            font-size: 5rem;
            font-weight: 100;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 120px;
            animation: spin 4s linear infinite;
        }
        @keyframes spin { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        .loading-bar-container { width: 200px; height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0; overflow: hidden; }
        .loading-bar-progress { width: 0%; height: 100%; background: #ffffff; transition: width 4s linear; }
        
        #notification { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-100px); opacity: 0; }
        #notification.show { transform: translateY(0); opacity: 1; }
        
        .preview-avatar { width: 80px; height: 80px; border-radius: 50%; background: #222; border: 2px solid rgba(255,255,255,0.1); object-fit: cover; overflow: hidden; }
        .preview-banner { width: 100%; height: 100px; background: #1a1a1a; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); object-fit: cover; overflow: hidden; }

        .font-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s ease; cursor: pointer; }
        .font-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); }
        .font-card.selected { background: #ffffff; color: #000000; border-color: #ffffff; }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <div id="notification" class="fixed top-8 left-1/2 -translate-x-1/2 z-[110]">
        <div class="glass-panel px-6 py-3 rounded-full border border-white/10 text-sm tracking-wide">
            <span id="notificationText"></span>
        </div>
    </div>

    <div id="loadingScreen">
        <div class="aura-logo-loading">A</div>
        <div class="text-white text-xs tracking-[0.4em] uppercase mb-1 font-light" id="loadingStatus">Processing</div>
        <div class="loading-bar-container">
            <div id="progressBar" class="loading-bar-progress"></div>
        </div>
        <p id="factText" class="text-gray-500 text-[10px] uppercase tracking-widest mt-4 max-w-xs text-center leading-relaxed px-6"></p>
    </div>

    <!-- SETUP WIZARD -->
    <div id="setupWizard" class="w-full max-w-xl p-6 hidden-state">
        <div class="text-center mb-8">
            <p id="stepIndicator" class="text-[10px] uppercase tracking-[0.4em] text-gray-500 mb-2">Step 1 of 3</p>
            <h2 class="text-2xl font-light tracking-widest uppercase">Identity Design</h2>
        </div>

        <div class="glass-panel rounded-3xl p-8 sm:p-10 transition-all duration-500">
            <div id="step1" class="space-y-8">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-400 mb-4">Profile Banner</label>
                    <div class="relative group cursor-pointer" onclick="document.getElementById('bannerInput').click()">
                        <div id="bannerPreview" class="preview-banner flex items-center justify-center text-[10px] text-gray-600 uppercase tracking-widest">Click to upload banner</div>
                        <input type="file" id="bannerInput" class="hidden" accept="image/*">
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('pfpInput').click()">
                        <div id="pfpPreviewContainer" class="preview-avatar flex items-center justify-center text-[10px] text-gray-600 uppercase text-center p-2 leading-tight">Upload PFP</div>
                        <input type="file" id="pfpInput" class="hidden" accept="image/*">
                    </div>
                    <div>
                        <h4 class="text-sm font-medium">Avatar & Presence</h4>
                        <p class="text-xs text-gray-500 mt-1">Recommended size 400x400px</p>
                    </div>
                </div>
                <button onclick="nextStep(2)" class="btn-primary w-full py-4 rounded-xl font-semibold mt-4 uppercase text-xs tracking-widest">Continue</button>
            </div>

            <div id="step2" class="hidden-state space-y-6">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Public Handle</label>
                    <input type="text" id="usernameInput" class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="@username" oninput="updatePreview()">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Name Color</label>
                        <div class="flex items-center space-x-3 bg-white/5 p-2 rounded-xl border border-white/10">
                            <input type="color" id="colorInput" class="w-10 h-10 bg-transparent border-0 cursor-pointer rounded-lg overflow-hidden" value="#ffffff" oninput="updatePreview()">
                            <span id="colorHex" class="text-[10px] uppercase font-mono text-gray-400">#FFFFFF</span>
                        </div>
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Preview</label>
                        <div class="flex items-center justify-center h-14 bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                            <span id="namePreview" class="text-lg tracking-tight truncate px-4">@username</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-400 mb-3">Signature Typography</label>
                    <div id="fontGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                </div>
                <div class="flex space-x-3 mt-8">
                    <button onclick="nextStep(1)" class="w-1/3 border border-white/10 hover:bg-white/5 py-4 rounded-xl text-xs uppercase tracking-widest">Back</button>
                    <button onclick="nextStep(3)" class="w-2/3 btn-primary py-4 rounded-xl font-semibold uppercase text-xs tracking-widest">Review</button>
                </div>
            </div>

            <div id="step3" class="hidden-state space-y-6">
                <div class="relative rounded-2xl overflow-hidden border border-white/10">
                    <div id="finalBanner" class="h-24 bg-zinc-900 bg-cover bg-center"></div>
                    <div class="px-6 pb-6 pt-0 -mt-8 flex flex-col items-center">
                        <div id="finalPfp" class="w-20 h-20 rounded-full border-4 border-[#0a0a0a] bg-zinc-800 bg-cover bg-center mb-4"></div>
                        <h3 id="finalName" class="text-xl">@username</h3>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">Aura Member</p>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-500 leading-relaxed">By finalizing, your identity will be etched into the Aura ledger.</p>
                <div class="flex space-x-3">
                    <button onclick="nextStep(2)" class="w-1/3 border border-white/10 hover:bg-white/5 py-4 rounded-xl text-xs uppercase tracking-widest">Edit</button>
                    <button onclick="finishSetup()" class="w-2/3 btn-primary py-4 rounded-xl font-semibold uppercase text-xs tracking-widest">Complete Setup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIN/SIGNUP -->
    <div id="mainContent" class="w-full max-w-md p-6 fade-in">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-extralight tracking-[0.3em] uppercase mb-2">Aura</h1>
            <p class="text-gray-500 text-sm tracking-widest uppercase">The Sovereign Social Club</p>
        </div>

        <div class="glass-panel rounded-3xl p-8 sm:p-10">
            <div id="loginSection">
                <h2 class="text-2xl font-medium mb-6">Sign In</h2>
                <form id="loginForm" class="space-y-5">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Email Address</label>
                        <input type="email" id="loginEmail" required class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="name@domain.com">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Password</label>
                        <input type="password" id="loginPass" required class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="••••••••">
                    </div>
                    <button type="submit" class="btn-primary w-full py-4 rounded-xl font-semibold mt-4 uppercase text-xs tracking-widest">Enter Aura</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-8">New to the circle? <button onclick="toggleAuth()" class="text-white hover:underline focus:outline-none ml-1">Request Membership</button></p>
            </div>

            <div id="signupSection" class="hidden-state">
                <h2 class="text-2xl font-medium mb-6">Join Aura</h2>
                <form id="signupForm" class="space-y-5">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Full Name</label>
                        <input type="text" id="signupName" required class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="Alexander Sterling">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Email Address</label>
                        <input type="email" id="signupEmail" required class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="name@domain.com">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">Create Password</label>
                        <input type="password" id="signupPass" required class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-600" placeholder="••••••••">
                    </div>
                    <button type="submit" class="btn-primary w-full py-4 rounded-xl font-semibold mt-4 uppercase text-xs tracking-widest">Create Account</button>
                </form>
                <p class="text-center text-gray-500 text-sm mt-8">Already recognized? <button onclick="toggleAuth()" class="text-white hover:underline focus:outline-none ml-1">Sign In</button></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aura-social-club';
        
        let currentUser = null;
        let userData = {
            pfp: 'https://images.unsplash.com/photo-1633332755192-727a05c4013d?w=200&h=200&fit=crop',
            banner: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800&h=300&fit=crop',
            username: '',
            color: '#ffffff',
            font: "'Plus Jakarta Sans'"
        };

        // Initialize Auth
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
        });

        // UI Logic
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const loadingScreen = document.getElementById('loadingScreen');
        const factText = document.getElementById('factText');
        const progressBar = document.getElementById('progressBar');
        const loadingStatus = document.getElementById('loadingStatus');

        const availableFonts = [
            { name: 'Classic Sans', value: "'Plus Jakarta Sans'" },
            { name: 'Luxe Serif', value: "'Playfair Display'" },
            { name: 'Monospace', value: "'Space Mono'" },
            { name: 'Editorial', value: "'Cormorant Garamond'" },
            { name: 'Modern', value: "'Inter'" },
            { name: 'Heritage', value: "'Baskervville'" }
        ];

        const facts = ["Privacy is the ultimate luxury.", "Fortune favors the bold.", "Exclusivity is a state of mind.", "Silence is elegant."];

        window.initFontGrid = () => {
            const grid = document.getElementById('fontGrid');
            grid.innerHTML = '';
            availableFonts.forEach(font => {
                const card = document.createElement('div');
                card.className = `font-card p-3 rounded-xl text-center flex flex-col items-center justify-center h-16 ${userData.font === font.value ? 'selected' : ''}`;
                card.innerHTML = `<span style="font-family: ${font.value}" class="text-sm">Aa</span><span class="text-[8px] uppercase tracking-widest mt-1 opacity-60">${font.name}</span>`;
                card.onclick = () => {
                    userData.font = font.value;
                    initFontGrid();
                    updatePreview();
                };
                grid.appendChild(card);
            });
        };

        window.showMessage = (text, isError = false) => {
            notificationText.innerText = text;
            notificationText.style.color = isError ? '#ff6b6b' : '#ffffff';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        };

        window.toggleAuth = () => {
            document.getElementById('loginSection').classList.toggle('hidden-state');
            document.getElementById('signupSection').classList.toggle('hidden-state');
        };

        window.startLoadingSequence = (message, isPermanent = false, callback = null) => {
            loadingScreen.classList.add('active');
            loadingStatus.innerText = message;
            factText.innerText = facts[Math.floor(Math.random() * facts.length)];
            progressBar.style.width = '0%';
            setTimeout(() => progressBar.style.width = '100%', 50);

            if (!isPermanent) {
                setTimeout(() => {
                    loadingScreen.classList.remove('active');
                    if (callback) callback();
                }, 4000);
            }
        };

        window.nextStep = (step) => {
            document.getElementById('step1').classList.add('hidden-state');
            document.getElementById('step2').classList.add('hidden-state');
            document.getElementById('step3').classList.add('hidden-state');
            document.getElementById(`step${step}`).classList.remove('hidden-state');
            document.getElementById('stepIndicator').innerText = `Step ${step} of 3`;
            if(step === 2) initFontGrid();
            if(step === 3) updateFinalReview();
        };

        window.updatePreview = () => {
            const username = document.getElementById('usernameInput').value || '@username';
            const color = document.getElementById('colorInput').value;
            document.getElementById('colorHex').innerText = color.toUpperCase();
            const namePreview = document.getElementById('namePreview');
            namePreview.innerText = username;
            namePreview.style.color = color;
            namePreview.style.fontFamily = userData.font;
            userData.username = username;
            userData.color = color;
        };

        window.updateFinalReview = () => {
            const finalName = document.getElementById('finalName');
            finalName.innerText = userData.username;
            finalName.style.color = userData.color;
            finalName.style.fontFamily = userData.font;
            if(userData.pfp) document.getElementById('finalPfp').style.backgroundImage = `url(${userData.pfp})`;
            if(userData.banner) document.getElementById('finalBanner').style.backgroundImage = `url(${userData.banner})`;
        };

        document.getElementById('pfpInput').onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                userData.pfp = ev.target.result;
                document.getElementById('pfpPreviewContainer').innerHTML = `<img src="${userData.pfp}" class="w-full h-full rounded-full object-cover">`;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('bannerInput').onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                userData.banner = ev.target.result;
                document.getElementById('bannerPreview').innerHTML = `<img src="${userData.banner}" class="w-full h-full rounded-xl object-cover">`;
            };
            reader.readAsDataURL(file);
        };

        window.finishSetup = async () => {
            if (!currentUser) {
                showMessage('Connection lost. Please wait...', true);
                return;
            }
            startLoadingSequence('Initializing Session', true);
            
            try {
                // Save to cloud storage (Firestore)
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                await setDoc(userDocRef, {
                    ...userData,
                    uid: currentUser.uid,
                    lastSeen: serverTimestamp()
                }, { merge: true });

                // Also save to public list
                const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'online_users', currentUser.uid);
                await setDoc(publicRef, {
                    username: userData.username,
                    pfp: userData.pfp,
                    color: userData.color,
                    font: userData.font,
                    uid: currentUser.uid,
                    lastSeen: serverTimestamp()
                });

                // Persist locally for the chat page
                localStorage.setItem('aura_setup_data', JSON.stringify(userData));
                
                setTimeout(() => {
                    window.location.href = 'chat.html';
                }, 3500);
            } catch (err) {
                console.error(err);
                showMessage('Error syncing dossier.', true);
                loadingScreen.classList.remove('active');
            }
        };

        document.getElementById('signupForm').addEventListener('submit', (e) => {
            e.preventDefault();
            startLoadingSequence('Account Created', false, () => {
                document.getElementById('mainContent').classList.add('hidden-state');
                document.getElementById('setupWizard').classList.remove('hidden-state');
                initFontGrid();
            });
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            startLoadingSequence('Authenticating', false, () => {
                document.getElementById('mainContent').classList.add('hidden-state');
                document.getElementById('setupWizard').classList.remove('hidden-state');
                initFontGrid();
            });
        });
    </script>
</body>
</html>
