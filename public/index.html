<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlaxy Pro | Next-Gen Communication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .msg-bubble-own {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 18px 18px 2px 18px;
        }

        .msg-bubble-other {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 18px 18px 18px 2px;
        }

        .hidden { display: none !important; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .online-indicator {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center">

    <!-- Auth View -->
    <div id="auth-view" class="w-full max-w-md p-4 animate-in fade-in zoom-in duration-300">
        <div class="glass-panel p-8 rounded-3xl shadow-2xl">
            <div class="flex flex-col items-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 mb-4">
                    <i class="fas fa-shield-halved text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight" id="auth-title">Welcome Back</h1>
                <p class="text-slate-400 text-sm mt-2" id="auth-subtitle">Access the galaxy of Pro chatters</p>
            </div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 ml-1">Email Address</label>
                    <input type="email" id="email" required placeholder="name@company.com" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 ml-1">Password</label>
                    <input type="password" id="password" required placeholder="••••••••" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                </div>

                <div id="auth-error" class="hidden text-red-400 text-xs bg-red-400/10 p-3 rounded-xl border border-red-400/20"></div>

                <button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/20 transition-all active:scale-[0.98]">
                    Sign In
                </button>
            </form>

            <div class="mt-6 flex flex-col gap-4">
                <button id="toggle-auth" class="text-sm text-slate-400 hover:text-white transition-colors text-center font-medium">
                    Don't have an account? Create one
                </button>
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-800"></span></div>
                    <div class="relative flex justify-center text-[10px] uppercase font-bold tracking-widest"><span class="bg-[#1e293b] px-3 text-slate-500">Or Access via</span></div>
                </div>
                <button id="guest-btn" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl transition-all font-semibold text-sm">
                    <i class="fas fa-user-secret mr-2"></i> Guest Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat View -->
    <div id="chat-view" class="hidden h-screen w-full flex flex-col md:flex-row overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
        
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-80 glass-panel border-r border-white/5">
            <div class="p-6 flex items-center gap-3 border-b border-white/5">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-shield-halved text-white"></i>
                </div>
                <h2 class="text-xl font-bold text-white tracking-tight">Chatlaxy Pro</h2>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-6 px-2">
                    <i class="fas fa-users"></i>
                    <span>Synchronized Users</span>
                </div>
                <div id="user-list" class="space-y-2">
                    <!-- Users injected here -->
                </div>
            </div>

            <div class="p-6 border-t border-white/5 bg-slate-900/40">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-11 h-11 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="current-user-email" class="text-sm font-bold text-white truncate">User</p>
                        <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Pro Member</p>
                    </div>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-400 text-sm font-bold transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout Session
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="flex-1 flex flex-col relative">
            <!-- Mobile Header -->
            <header class="md:hidden p-4 glass-panel border-b border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-shield-halved text-blue-500"></i>
                    <h1 class="font-bold text-white">Chatlaxy Pro</h1>
                </div>
                <button id="mobile-logout" class="text-red-400"><i class="fas fa-sign-out-alt text-lg"></i></button>
            </header>

            <!-- Message Feed -->
            <div id="message-feed" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar">
                <!-- Messages injected here -->
            </div>

            <!-- Input Bar -->
            <div class="p-4 md:p-8 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent">
                <form id="message-form" class="max-w-4xl mx-auto relative flex items-center">
                    <input type="text" id="message-input" autocomplete="off"
                        class="w-full bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl px-6 py-4 pr-16 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-slate-200 placeholder-slate-500 shadow-2xl"
                        placeholder="Broadcast to the galaxy...">
                    <button type="submit" class="absolute right-2 bg-blue-600 hover:bg-blue-500 p-3 rounded-xl transition-all active:scale-90 shadow-lg shadow-blue-600/30">
                        <i class="fas fa-paper-plane text-white"></i>
                    </button>
                </form>
                <div class="flex justify-center mt-4">
                   <span class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">
                        <i class="fas fa-lock mr-1"></i> End-to-End Encrypted Tunnel Active
                   </span>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            signInAnonymously, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp,
            doc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Firebase Config & Init ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chatlaxy-pro-v2';

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const chatView = document.getElementById('chat-view');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const submitBtn = document.getElementById('submit-btn');
        const toggleAuth = document.getElementById('toggle-auth');
        const guestBtn = document.getElementById('guest-btn');
        const messageFeed = document.getElementById('message-feed');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userList = document.getElementById('user-list');
        const currentUserEmail = document.getElementById('current-user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const mobileLogout = document.getElementById('mobile-logout');

        let isLogin = true;

        // --- Auth Logic ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) {}
            }
        };

        toggleAuth.addEventListener('click', () => {
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? 'Welcome Back' : 'Join the Galaxy';
            authSubtitle.innerText = isLogin ? 'Access the galaxy of Pro chatters' : 'Create your secure account in seconds';
            submitBtn.innerText = isLogin ? 'Sign In' : 'Create Account';
            toggleAuth.innerText = isLogin ? "Don't have an account? Create one" : "Already a member? Sign In";
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.classList.add('hidden');
            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                authError.innerText = err.message.replace('Firebase: ', '');
                authError.classList.remove('hidden');
            }
        });

        guestBtn.addEventListener('click', () => signInAnonymously(auth));
        const handleLogout = () => signOut(auth);
        logoutBtn.addEventListener('click', handleLogout);
        mobileLogout.addEventListener('click', handleLogout);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authView.classList.add('hidden');
                chatView.classList.remove('hidden');
                currentUserEmail.innerText = user.email || 'Guest User';
                updatePresence(user);
                startListeners(user);
            } else {
                authView.classList.remove('hidden');
                chatView.classList.add('hidden');
            }
        });

        // --- Firestore Logic ---
        async function updatePresence(user) {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                email: user.email || `Guest-${user.uid.slice(0,4)}`,
                lastSeen: serverTimestamp(),
                online: true
            }, { merge: true });
        }

        function startListeners(currentUser) {
            // Messages Listener
            const msgQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'));
            onSnapshot(msgQ, (snapshot) => {
                const msgs = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                renderMessages(msgs, currentUser);
            }, (err) => console.error("Msg Error:", err));

            // Users Listener
            const userQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            onSnapshot(userQ, (snapshot) => {
                const users = snapshot.docs.map(d => d.data());
                renderUsers(users);
            }, (err) => console.error("User Error:", err));
        }

        function renderMessages(msgs, currentUser) {
            messageFeed.innerHTML = msgs.length === 0 
                ? `<div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-40">
                    <i class="fas fa-comment-dots text-5xl mb-4"></i>
                    <p class="font-bold tracking-widest uppercase text-xs">Awaiting first broadcast...</p>
                   </div>`
                : msgs.map(msg => {
                    const isOwn = msg.uid === currentUser.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    return `
                        <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300">
                            <div class="max-w-[85%] md:max-w-[70%] group">
                                <div class="flex items-center gap-2 mb-1 px-2 ${isOwn ? 'flex-row-reverse' : ''}">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${msg.email ? msg.email.split('@')[0] : 'Guest'}</span>
                                    <span class="text-[9px] text-slate-700 font-bold opacity-0 group-hover:opacity-100 transition-opacity">${time}</span>
                                </div>
                                <div class="px-5 py-3 shadow-xl ${isOwn ? 'msg-bubble-own text-white' : 'msg-bubble-other text-slate-200'}">
                                    <p class="text-sm leading-relaxed">${msg.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            messageFeed.scrollTop = messageFeed.scrollHeight;
        }

        function renderUsers(users) {
            userList.innerHTML = users.map(u => `
                <div class="flex items-center gap-3 p-3 rounded-2xl hover:bg-white/5 transition-all group cursor-default">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-slate-400">
                            ${(u.email || 'G')[0].toUpperCase()}
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-4 border-[#1e293b] rounded-full online-indicator"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-300 truncate">${u.email ? u.email.split('@')[0] : 'Guest'}</p>
                        <p class="text-[10px] text-slate-500 font-medium">Active Now</p>
                    </div>
                </div>
            `).join('');
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !auth.currentUser) return;

            messageInput.value = '';
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text,
                    uid: auth.currentUser.uid,
                    email: auth.currentUser.email || `Guest-${auth.currentUser.uid.slice(0,4)}`,
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                console.error("Send error:", err);
            }
        });

        initAuth();
    </script>
</body>
</html>
