<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleChat | Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .message-in {
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        body { background-color: #f8fafc; }
    </style>
</head>
<body class="h-screen flex items-center justify-center font-sans">

    <!-- Auth Container -->
    <div id="auth-screen" class="w-full max-w-md p-8 bg-white shadow-2xl rounded-2xl mx-4">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                <i data-lucide="message-square" class="text-white w-8 h-8"></i>
            </div>
            <h1 id="auth-title" class="text-2xl font-bold text-gray-900">Welcome Back</h1>
            <p id="auth-subtitle" class="text-gray-500 text-sm mt-1">Login to start chatting</p>
        </div>

        <form id="auth-form" class="space-y-4">
            <div>
                <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Email Address</label>
                <input type="email" id="email" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Password</label>
                <input type="password" id="password" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
            </div>
            
            <div id="auth-error" class="hidden text-red-500 text-xs p-3 bg-red-50 border border-red-100 rounded-lg"></div>

            <button type="submit" id="submit-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-100">
                Sign In
            </button>
        </form>

        <div class="mt-6 flex flex-col gap-3">
            <button id="toggle-auth" class="text-sm text-blue-600 font-medium hover:underline">
                Need an account? Sign up
            </button>
            <div class="relative py-2">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400">Or</span></div>
            </div>
            <button id="guest-btn" class="w-full py-3 bg-white border border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition-all">
                Enter as Guest
            </button>
        </div>
    </div>

    <!-- Chat App (Hidden by default) -->
    <div id="chat-screen" class="hidden fixed inset-0 flex flex-col bg-white">
        <!-- Header -->
        <header class="h-16 border-b flex items-center justify-between px-6 bg-white/80 backdrop-blur-md sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="message-circle" class="text-white w-4 h-4"></i>
                </div>
                <div>
                    <h2 class="font-bold text-gray-800 text-sm">Public Lounge</h2>
                    <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">Live Connection</p>
                </div>
            </div>
            <button id="logout-btn" class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-lg transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- Messages Area -->
        <div id="messages-list" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-slate-50/50">
            <!-- Messages will appear here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t bg-white">
            <form id="chat-form" class="max-w-4xl mx-auto flex gap-2">
                <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off"
                    class="flex-1 px-4 py-3 bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition-all flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Environment Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'simple-chat-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "demo", projectId: "demo" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isSignUp = false;

        // UI Helpers
        const el = (id) => document.getElementById(id);
        const refreshIcons = () => lucide.createIcons();

        // 1. Auth Flow Logic
        el('toggle-auth').addEventListener('click', () => {
            isSignUp = !isSignUp;
            el('auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
            el('auth-subtitle').textContent = isSignUp ? 'Join the community today' : 'Login to start chatting';
            el('submit-btn').textContent = isSignUp ? 'Create Account' : 'Sign In';
            el('toggle-auth').textContent = isSignUp ? 'Have an account? Login' : 'Need an account? Sign up';
        });

        el('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = el('email').value;
            const password = el('password').value;
            const errorDiv = el('auth-error');
            
            errorDiv.classList.add('hidden');
            
            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.classList.remove('hidden');
            }
        });

        el('guest-btn').addEventListener('click', () => signInAnonymously(auth));
        el('logout-btn').addEventListener('click', () => signOut(auth));

        // 2. Chat Logic (Subscription)
        function subscribeToMessages() {
            // RULE 1 & 2: Use strict paths and simple queries
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'messages'),
                orderBy('timestamp', 'asc'),
                limit(100)
            );

            onSnapshot(q, (snapshot) => {
                const list = el('messages-list');
                list.innerHTML = '';
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.uid === auth.currentUser.uid;
                    const messageEl = document.createElement('div');
                    messageEl.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} message-in`;
                    
                    messageEl.innerHTML = `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-gray-400">${isMe ? 'You' : data.email.split('@')[0]}</span>
                        </div>
                        <div class="max-w-[75%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border rounded-tl-none text-gray-800'} shadow-sm">
                            ${data.text}
                        </div>
                    `;
                    list.appendChild(messageEl);
                });
                
                list.scrollTop = list.scrollHeight;
            }, (err) => {
                console.error("Firestore stream error:", err);
            });
        }

        // 3. Message Sending
        el('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = el('chat-input');
            const text = input.value.trim();
            if (!text || !auth.currentUser) return;

            input.value = '';
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text,
                    uid: auth.currentUser.uid,
                    email: auth.currentUser.email || 'Guest',
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                console.error("Send failed:", err);
            }
        });

        // 4. Initial State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                el('auth-screen').classList.add('hidden');
                el('chat-screen').classList.remove('hidden');
                subscribeToMessages();
            } else {
                el('auth-screen').classList.remove('hidden');
                el('chat-screen').classList.add('hidden');
                el('messages-list').innerHTML = '';
            }
            refreshIcons();
        });

        refreshIcons();
    </script>
</body>
</html>
