<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlaxy Pro | Secure Communications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=Roboto+Mono&family=Playfair+Display&display=swap');
        
        :root {
            --accent: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }

        .galaxy-bg {
            background: radial-gradient(circle at top right, #0f172a, #020617);
            position: relative;
        }

        .galaxy-bg::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.2;
            pointer-events: none;
        }

        /* Modern Rectangular Card Styling */
        .auth-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .input-field {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* User Animations */
        .user-anim-pulse { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .user-anim-float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }

        .user-anim-bounce { animation: bounce-soft 2s infinite; }
        @keyframes bounce-soft {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .font-sans { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-[#020617] flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center gap-6">
            <div class="relative w-16 h-16">
                <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
            </div>
            <div class="text-center">
                <h2 class="text-xl font-bold tracking-widest text-white uppercase">Chatlaxy Pro</h2>
                <p class="text-slate-500 text-xs mt-2 animate-pulse">Establishing secure uplink...</p>
            </div>
        </div>
    </div>

    <!-- Auth View -->
    <div id="auth-view" class="hidden min-h-screen galaxy-bg flex items-center justify-center p-6 overflow-y-auto">
        <div class="w-full max-w-[480px] auth-card rounded-none border-t-4 border-t-blue-500 p-10 animate-fade-in">
            <div class="flex flex-col items-center mb-10">
                <div class="w-12 h-12 bg-blue-600 flex items-center justify-center mb-4">
                    <i data-lucide="shield" class="text-white w-6 h-6"></i>
                </div>
                <h2 id="auth-title" class="text-2xl font-bold tracking-tight text-white uppercase italic">Access Terminal</h2>
                <p id="auth-subtitle" class="text-slate-400 text-sm mt-1">Ident: Guest_Session_Pending</p>
            </div>

            <form id="auth-form" class="space-y-6">
                <!-- Signup Specific Blocks -->
                <div id="signup-fields" class="hidden space-y-6">
                    <div class="flex items-center gap-6 pb-6 border-b border-slate-800">
                        <div class="relative group">
                            <div id="pfp-preview" class="w-20 h-20 bg-slate-900 border border-slate-800 flex items-center justify-center overflow-hidden">
                                <i data-lucide="user" class="w-8 h-8 text-slate-700"></i>
                            </div>
                            <label class="absolute inset-0 bg-blue-600/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-all">
                                <i data-lucide="plus" class="text-white"></i>
                                <input type="file" id="pfp-input" accept="image/*" class="hidden">
                            </label>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-blue-500 uppercase mb-2 block">Username</label>
                            <input type="text" id="username" placeholder="OPERATOR_NAME" class="w-full input-field px-4 py-2 text-white">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Theme Tint</label>
                            <input type="color" id="pfp-color" value="#3b82f6" class="w-full h-10 bg-transparent cursor-pointer border-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">VFX Signal</label>
                            <select id="user-animation" class="w-full input-field text-white text-xs px-2 h-10">
                                <option value="none">Static</option>
                                <option value="user-anim-pulse">Pulse</option>
                                <option value="user-anim-float">Hover</option>
                                <option value="user-anim-bounce">Active</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Cipher Font</label>
                        <select id="user-font" class="w-full input-field text-white text-xs px-2 h-10">
                            <option value="font-sans">Standard Inter</option>
                            <option value="font-mono">Terminal Mono</option>
                            <option value="font-cyber">Galaxy Orbitron</option>
                            <option value="font-serif">Classic Serif</option>
                        </select>
                    </div>
                </div>

                <!-- Shared Fields -->
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Email Reference</label>
                        <input type="email" id="email" required placeholder="admin@galaxy.net" class="w-full input-field px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Security Token</label>
                        <input type="password" id="password" required placeholder="••••••••" class="w-full input-field px-4 py-3 text-white">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="remember-me" class="w-4 h-4 rounded-none border-slate-700 bg-slate-900 text-blue-600 focus:ring-0">
                        <span class="text-[10px] text-slate-500 group-hover:text-slate-300 transition-colors uppercase">Maintain Link (Persistence)</span>
                    </label>
                </div>

                <div id="auth-error" class="hidden text-red-500 text-[10px] bg-red-500/5 p-3 border-l-2 border-red-500 uppercase tracking-tighter"></div>

                <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-4 uppercase tracking-widest transition-all">
                    Initiate Uplink
                </button>
            </form>

            <div class="mt-8 pt-6 border-t border-slate-800 flex flex-col gap-4">
                <button id="toggle-view" class="text-[10px] text-blue-500 hover:text-blue-400 text-center uppercase font-bold tracking-widest">
                    Request New Account Access
                </button>
                <button id="guest-access" class="text-[10px] text-slate-500 hover:text-white text-center uppercase tracking-widest">
                    Standard Guest Entry
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat View -->
    <div id="chat-view" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden galaxy-bg">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 bg-[#020617]/90 border-r border-slate-800 flex flex-col">
            <div class="p-6 border-b border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                    <span class="text-sm font-bold tracking-widest uppercase">Nodes Online</span>
                </div>
                <span id="online-count" class="text-xs text-slate-500 font-mono">0</span>
            </div>
            
            <div id="user-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar"></div>

            <div class="p-6 border-t border-slate-800 bg-black/20">
                <div class="flex items-center gap-3 mb-6">
                    <div id="my-pfp" class="w-10 h-10 border border-slate-800 flex items-center justify-center overflow-hidden">
                        <i data-lucide="user" class="text-slate-500"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-xs font-bold uppercase truncate">Guest_User</p>
                        <p class="text-[9px] text-slate-500 uppercase font-mono tracking-tighter">ID: Secure_Session</p>
                    </div>
                    <button id="logout-btn" class="p-2 text-slate-500 hover:text-red-500 transition-colors">
                        <i data-lucide="power" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Chat Container -->
        <main class="flex-1 flex flex-col">
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar"></div>

            <div class="p-6">
                <form id="msg-form" class="max-w-4xl mx-auto flex gap-4">
                    <div class="flex-1 relative">
                        <input type="text" id="msg-input" autocomplete="off" 
                            class="w-full bg-slate-900/50 border border-slate-800 text-slate-200 px-6 py-4 text-sm focus:outline-none focus:border-blue-500"
                            placeholder="TRANSMIT MESSAGE...">
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 px-8 py-4 transition-all flex items-center justify-center">
                        <i data-lucide="send" class="w-5 h-5 text-white"></i>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signOut, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            setDoc,
            getDoc,
            getDocs,
            where,
            limit
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Setup
        const manualApiKey = "AIzaSyDncManQICLPVT8WuMVO5kB-Am32VI12wo";
        let firebaseConfig = { 
            apiKey: manualApiKey, 
            authDomain: "chatlaxy-pro.firebaseapp.com", 
            projectId: "chatlaxy-pro"
        };
        
        if (typeof __firebase_config !== 'undefined') {
            const remoteConfig = JSON.parse(__firebase_config);
            firebaseConfig = { ...firebaseConfig, ...remoteConfig };
            firebaseConfig.apiKey = manualApiKey;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chatlaxy-pro-v2';

        // State
        let currentMode = 'login';
        let currentUser = null;
        let userData = null;
        let pfpBase64 = null;

        // UI Helpers
        const el = (id) => document.getElementById(id);
        const hideLoading = () => {
            el('loading-overlay').style.opacity = '0';
            setTimeout(() => el('loading-overlay').classList.add('hidden'), 500);
        };

        // Initialize Icons
        const refreshIcons = () => lucide.createIcons();

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid));
                userData = userDoc.exists() ? userDoc.data() : null;
                
                setupAppUI(user);
                startSubscriptions();
                el('auth-view').classList.add('hidden');
                el('chat-view').classList.remove('hidden');
                el('chat-view').style.display = 'flex';
            } else {
                el('auth-view').classList.remove('hidden');
                el('chat-view').classList.add('hidden');
                el('chat-view').style.display = 'none';
            }
            hideLoading();
            refreshIcons();
        });

        // Set a hard timeout to hide loading in case of network issues
        setTimeout(hideLoading, 5000);

        // Toggle View
        el('toggle-view').addEventListener('click', () => {
            currentMode = currentMode === 'login' ? 'signup' : 'login';
            el('auth-title').textContent = currentMode === 'login' ? 'Access Terminal' : 'Registrar';
            el('signup-fields').classList.toggle('hidden', currentMode === 'login');
            el('auth-submit-btn').textContent = currentMode === 'login' ? 'Initiate Uplink' : 'Finalize Registry';
            el('toggle-view').textContent = currentMode === 'login' ? 'Request New Account Access' : 'Return to Login';
        });

        // PFP Upload
        el('pfp-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    pfpBase64 = ev.target.result;
                    el('pfp-preview').innerHTML = `<img src="${pfpBase64}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Submit Auth
        el('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            el('auth-error').classList.add('hidden');
            
            try {
                const persistence = el('remember-me').checked ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);

                if (currentMode === 'login') {
                    let loginEmail = el('email').value;
                    if (!loginEmail.includes('@')) {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where("username", "==", loginEmail), limit(1));
                        const snap = await getDocs(q);
                        if (!snap.empty) loginEmail = snap.docs[0].data().email;
                    }
                    await signInWithEmailAndPassword(auth, loginEmail, el('password').value);
                } else {
                    const cred = await createUserWithEmailAndPassword(auth, el('email').value, el('password').value);
                    const profile = {
                        uid: cred.user.uid,
                        username: el('username').value || el('email').value.split('@')[0],
                        email: el('email').value,
                        pfp: pfpBase64,
                        color: el('pfp-color').value,
                        animation: el('user-animation').value,
                        font: el('user-font').value,
                        online: true,
                        lastSeen: serverTimestamp()
                    };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', cred.user.uid), profile);
                    userData = profile;
                }
            } catch (err) {
                el('auth-error').textContent = err.message.replace('Firebase:', '').trim();
                el('auth-error').classList.remove('hidden');
            }
        });

        // App Functions
        const setupAppUI = (user) => {
            const name = userData?.username || user.email?.split('@')[0] || 'Guest';
            el('user-name').textContent = name;
            if (userData?.pfp) {
                el('my-pfp').innerHTML = `<img src="${userData.pfp}" class="w-full h-full object-cover">`;
            }
            el('my-pfp').style.borderColor = userData?.color || '#334155';
            if (userData?.animation) el('my-pfp').classList.add(userData.animation);
        };

        const startSubscriptions = () => {
            const msgQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'));
            onSnapshot(msgQuery, async (snap) => {
                const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                const userMap = {};
                usersSnap.forEach(d => userMap[d.id] = d.data());
                
                const msgs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                renderMessages(msgs, userMap);
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                const onlineUsers = snap.docs.map(d => d.data()).filter(u => u.online !== false);
                renderUserList(onlineUsers);
            });
        };

        const renderMessages = (msgs, userMap) => {
            el('messages').innerHTML = msgs.map(m => {
                const isOwn = m.uid === currentUser.uid;
                const sender = userMap[m.uid] || {};
                const name = sender.username || m.email?.split('@')[0] || 'Unknown';
                const time = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                
                return `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} ${sender.font || 'font-sans'}">
                    <div class="max-w-[80%] flex items-start gap-4 ${isOwn ? 'flex-row-reverse' : ''}">
                        <div class="w-8 h-8 flex-shrink-0 border border-slate-800 bg-slate-900 ${sender.animation || ''}" style="border-color: ${sender.color || '#334155'}">
                            ${sender.pfp ? `<img src="${sender.pfp}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] font-bold text-slate-500">${name[0]}</div>`}
                        </div>
                        <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'}">
                            <span class="text-[9px] font-bold uppercase tracking-widest text-slate-600 mb-1" style="color: ${sender.color || '#475569'}">${name} <span class="opacity-40 font-normal ml-2">${time}</span></span>
                            <div class="px-4 py-3 text-sm border bg-slate-900/40" style="border-color: ${sender.color || '#334155'}; color: ${isOwn ? '#fff' : '#cbd5e1'}">
                                ${m.text}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            el('messages').scrollTop = el('messages').scrollHeight;
        };

        const renderUserList = (users) => {
            el('online-count').textContent = users.length;
            el('user-list').innerHTML = users.map(u => {
                const name = u.username || u.email?.split('@')[0] || 'Unknown';
                return `
                <div class="flex items-center gap-3 p-3 hover:bg-slate-800/20 transition-all border-l-2 border-transparent hover:border-blue-500">
                    <div class="w-8 h-8 border border-slate-800 bg-slate-900 overflow-hidden ${u.animation || ''}" style="border-color: ${u.color || '#334155'}">
                        ${u.pfp ? `<img src="${u.pfp}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] text-slate-500">${name[0]}</div>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold uppercase truncate" style="color: ${u.color || '#94a3b8'}">${name}</p>
                    </div>
                </div>`;
            }).join('');
        };

        // Actions
        el('msg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = el('msg-input').value.trim();
            if (!text || !currentUser) return;
            el('msg-input').value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                text,
                uid: currentUser.uid,
                email: currentUser.email,
                timestamp: serverTimestamp()
            });
        });

        el('guest-access').addEventListener('click', () => signInAnonymously(auth));
        el('logout-btn').addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
