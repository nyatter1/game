<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraChat Pro - Node.js Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .active-tab { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .glass-sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .avatar-lg { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .online-dot { width: 12px; height: 12px; background: #22c55e; border-radius: 50%; border: 2px solid white; }
        .message-blob { max-width: 75%; }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen overflow-hidden">

    <!-- Hidden File Input for PFP Updates -->
    <input type="file" id="update-pfp-input" accept="image/*" class="hidden">

    <!-- AUTH SECTION -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex border-b text-center">
                <button id="tab-login" class="flex-1 py-4 font-bold active-tab">Login</button>
                <button id="tab-signup" class="flex-1 py-4 font-bold text-gray-400">Sign Up</button>
            </div>
            
            <div class="p-8">
                <!-- Login Form -->
                <div id="login-form" class="space-y-4">
                    <input type="text" id="login-user" placeholder="Username" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="btn-login-action" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Enter Chat</button>
                    <p id="login-error" class="text-red-500 text-xs text-center hidden font-medium">Invalid username or password.</p>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="hidden space-y-4 overflow-y-auto max-h-[60vh]">
                    <input type="text" id="reg-user" placeholder="Username" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="email" id="reg-email" placeholder="Email" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="reg-pass" placeholder="Password" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="flex gap-2">
                        <input type="number" id="reg-age" placeholder="Age (8-1000)" min="8" max="1000" class="w-1/2 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="reg-gender" class="w-1/2 p-3 border rounded-lg outline-none bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">Gender...</option>
                        </select>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 mb-2">Click photo to upload</p>
                        <input type="file" id="reg-pfp" accept="image/*" class="hidden">
                        <img id="pfp-preview" src="https://ui-avatars.com/api/?name=?" class="avatar-lg mx-auto cursor-pointer border-4 border-blue-50 hover:opacity-80" onclick="document.getElementById('reg-pfp').click()">
                    </div>
                    <button id="btn-signup-action" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="app-screen" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-80 glass-sidebar border-r flex flex-col shadow-xl">
            <div class="p-6 bg-blue-600 text-white flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('update-pfp-input').click()">
                        <img id="my-pfp" src="" class="w-12 h-12 rounded-full border-2 border-white object-cover transition group-hover:brightness-75">
                        <div class="online-dot absolute bottom-0 right-0"></div>
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                    </div>
                    <div>
                        <p id="my-username-display" class="font-bold leading-none text-lg">User</p>
                        <p id="my-gender-display" class="text-[10px] opacity-80 uppercase tracking-widest mt-1">Gamer</p>
                    </div>
                </div>
                <button id="btn-logout" class="p-2 hover:bg-white/20 rounded-full transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>

            <div class="p-4 bg-gray-50 border-b flex justify-around text-xs font-black uppercase text-gray-400 tracking-tighter">
                <button onclick="switchChat('global')" id="view-global-btn" class="active-tab pb-2 flex items-center gap-1">üåç Public</button>
                <button onclick="switchChat('private')" id="view-private-btn" class="pb-2 flex items-center gap-1">üí¨ PMs</button>
            </div>

            <div id="sidebar-list" class="flex-1 overflow-y-auto">
                <!-- Users populate here -->
            </div>
        </aside>

        <!-- Chat Main -->
        <main class="flex-1 flex flex-col bg-white">
            <div class="p-4 border-b flex items-center justify-between shadow-sm bg-white z-10">
                <div class="flex items-center gap-3">
                    <div id="target-icon" class="text-3xl">üåç</div>
                    <div>
                        <h2 id="chat-title" class="font-bold text-gray-800 text-lg">Global Square</h2>
                        <p id="chat-status" class="text-xs text-green-500 font-medium">Online Now</p>
                    </div>
                </div>
            </div>

            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                <!-- Messages populate here -->
            </div>

            <form id="chat-form" class="p-4 bg-white border-t flex gap-3 items-center">
                <input type="text" id="msg-input" placeholder="Type something..." class="flex-1 bg-gray-100 p-3 rounded-full px-6 outline-none focus:ring-2 focus:ring-blue-400">
                <button type="submit" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 shadow-lg transform transition active:scale-90">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </form>
        </main>
    </div>

    <script>
        const socket = io();
        
        // --- State ---
        let myProfile = null;
        let targetId = 'global';
        let chatHistory = { 'global': [] };
        let pfpBase64 = null;
        
        // Client-side account storage (Simulated Database)
        let registeredUsers = [];

        const genders = [
            "Male", "Female", "Non-binary", "Agender", "Table", "UFO", "Attack Helicopter", "Walrus", "Potato", "Wireless Router", 
            "Cloud", "Void", "Glitch", "Cyber-organic", "Nebula", "Pizza", "Dinosaur", "Unicorn", "Wizard", "Toaster", 
            "Shadow", "Particle", "Vibe", "AI Consciousness", "Time Traveler", "Space Dust", "Binary Code", "Nature Spirit", 
            "Dragon", "Cat", "Dog", "Meme Lord", "Gamer", "Ghost", "Alien", "Pixel", "Echo", "Spectrum", "Myth", "Legend", 
            "The One", "Cisgender", "Genderfluid", "Genderqueer", "Intersex", "Pangender", "Transgender", "Two-Spirit", "Bigender", "Androgyne"
        ];

        // --- Init ---
        window.onload = () => {
            const genderSelect = document.getElementById('reg-gender');
            genders.sort().forEach(g => {
                const opt = document.createElement('option');
                opt.value = g; opt.textContent = g;
                genderSelect.appendChild(opt);
            });

            // Load saved accounts from localStorage if available
            const saved = localStorage.getItem('aura_users');
            if(saved) registeredUsers = JSON.parse(saved);
        };

        // --- Auth UI Toggles ---
        document.getElementById('tab-login').onclick = () => toggleAuth('login');
        document.getElementById('tab-signup').onclick = () => toggleAuth('signup');

        function toggleAuth(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', mode === 'login');
            document.getElementById('tab-login').className = mode === 'login' ? 'flex-1 py-4 font-bold active-tab' : 'flex-1 py-4 font-bold text-gray-400';
            document.getElementById('tab-signup').className = mode === 'signup' ? 'flex-1 py-4 font-bold active-tab' : 'flex-1 py-4 font-bold text-gray-400';
            document.getElementById('login-error').classList.add('hidden');
        }

        // --- Signup Logic ---
        document.getElementById('reg-pfp').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                pfpBase64 = ev.target.result;
                document.getElementById('pfp-preview').src = pfpBase64;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // --- In-App PFP Update Logic ---
        document.getElementById('update-pfp-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const newPfp = ev.target.result;
                myProfile.pfp = newPfp;
                document.getElementById('my-pfp').src = newPfp;
                // Update local storage record if logged in
                const idx = registeredUsers.findIndex(u => u.username === myProfile.username);
                if(idx !== -1) {
                    registeredUsers[idx].pfp = newPfp;
                    localStorage.setItem('aura_users', JSON.stringify(registeredUsers));
                }
                // Emit update to server
                socket.emit('update pfp', newPfp);
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('btn-signup-action').onclick = () => {
            const user = document.getElementById('reg-user').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const age = parseInt(document.getElementById('reg-age').value);
            const gender = document.getElementById('reg-gender').value;
            const pass = document.getElementById('reg-pass').value;

            if (!user || !pass || !email || age < 8 || age > 1000 || !gender) return alert("Fill everything! Age 8-1000.");
            
            // Check if user already exists
            if (registeredUsers.some(u => u.username.toLowerCase() === user.toLowerCase())) {
                return alert("Username already taken!");
            }

            const newUser = {
                username: user,
                password: pass, // Simple plain text for demo
                email: email,
                age: age,
                gender: gender,
                pfp: pfpBase64 || `https://ui-avatars.com/api/?name=${user}&background=random`
            };

            registeredUsers.push(newUser);
            localStorage.setItem('aura_users', JSON.stringify(registeredUsers));
            
            myProfile = newUser;
            socket.emit('register user', myProfile);
            enterApp();
        };

        document.getElementById('btn-login-action').onclick = () => {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value;
            const errorEl = document.getElementById('login-error');

            if (!user || !pass) {
                errorEl.innerText = "Please enter both fields.";
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Validate against "database"
            const account = registeredUsers.find(u => 
                u.username.toLowerCase() === user.toLowerCase() && u.password === pass
            );

            if (account) {
                myProfile = account;
                socket.emit('register user', myProfile);
                enterApp();
            } else {
                errorEl.innerText = "Invalid username or password.";
                errorEl.classList.remove('hidden');
            }
        };

        function enterApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('my-pfp').src = myProfile.pfp;
            document.getElementById('my-username-display').innerText = myProfile.username;
            document.getElementById('my-gender-display').innerText = myProfile.gender || "Online";
        }

        document.getElementById('btn-logout').onclick = () => location.reload();

        // --- Socket Listeners ---
        socket.on('update user list', (users) => {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            users.forEach(u => {
                if (u.id === socket.id) return;
                const div = document.createElement('div');
                div.className = `p-4 flex items-center gap-3 hover:bg-blue-50 cursor-pointer border-b transition ${targetId === u.id ? 'bg-blue-50' : ''}`;
                div.onclick = () => switchChat(u.id, u.username, u.pfp, u.gender, u.age);
                div.innerHTML = `
                    <div class="relative">
                        <img src="${u.pfp}" class="avatar-sm shadow-sm">
                        <div class="online-dot absolute bottom-0 right-0 scale-75"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${u.username}</p>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-tight">${u.gender || 'User'}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        });

        function switchChat(id, name = "Global Square", pfp = null, gender = null, age = null) {
            targetId = id;
            if (id === 'global') {
                document.getElementById('chat-title').innerText = "Global Square";
                document.getElementById('target-icon').innerText = "üåç";
                document.getElementById('chat-status').innerText = "Public Channel";
            } else {
                document.getElementById('chat-title').innerText = name;
                document.getElementById('target-icon').innerHTML = `<img src="${pfp}" class="avatar-sm">`;
                document.getElementById('chat-status').innerText = `${gender} ‚Ä¢ Age ${age}`;
            }
            renderMessages();
        }

        // --- Messaging ---
        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            const msg = {
                senderId: socket.id,
                senderName: myProfile.username,
                senderPfp: myProfile.pfp,
                text: text,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            if (targetId === 'global') {
                socket.emit('global message', msg);
            } else {
                msg.targetId = targetId;
                if (!chatHistory[targetId]) chatHistory[targetId] = [];
                chatHistory[targetId].push(msg);
                socket.emit('private message', msg);
                renderMessages();
            }
            input.value = '';
        };

        socket.on('global message', (msg) => {
            chatHistory['global'].push(msg);
            if (targetId === 'global') renderMessages();
        });

        socket.on('private message', (msg) => {
            const sid = msg.senderId;
            if (!chatHistory[sid]) chatHistory[sid] = [];
            chatHistory[sid].push(msg);
            if (targetId === sid) renderMessages();
        });

        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            const msgs = chatHistory[targetId] || [];
            
            msgs.forEach(m => {
                const isMe = m.senderId === socket.id;
                const div = document.createElement('div');
                div.className = `flex gap-3 ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
                div.innerHTML = `
                    <img src="${m.senderPfp}" class="w-9 h-9 rounded-full self-end shadow-sm object-cover">
                    <div class="message-blob">
                        <div class="px-4 py-2 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}">
                            ${m.text}
                        </div>
                        <p class="text-[9px] text-gray-400 mt-1 px-1">${isMe ? 'You' : m.senderName} ‚Ä¢ ${m.timestamp}</p>
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
