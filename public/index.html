<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlaxy Pro</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons via CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .galaxy-bg {
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }

        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-msg {
            animation: fadeIn 0.3s ease forwards;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 bg-[#0f172a] flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            <p class="text-slate-400 text-sm animate-pulse">Initializing Galaxy...</p>
        </div>
    </div>

    <!-- Auth View -->
    <div id="auth-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-[#1e293b] rounded-2xl shadow-2xl border border-slate-700/50 overflow-hidden">
            <div class="p-8">
                <div class="flex justify-center mb-6">
                    <div class="bg-blue-600 p-3 rounded-xl shadow-lg shadow-blue-500/20">
                        <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                    </div>
                </div>
                <h2 id="auth-title" class="text-3xl font-bold text-center text-white mb-2">Welcome Back</h2>
                <p id="auth-subtitle" class="text-center text-slate-400 mb-8">Enter your details to access Chatlaxy Pro</p>

                <form id="auth-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">Email Address</label>
                        <input type="email" id="email" required placeholder="name@example.com"
                            class="w-full bg-[#0f172a] border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">Password</label>
                        <input type="password" id="password" required placeholder="••••••••"
                            class="w-full bg-[#0f172a] border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-white">
                    </div>

                    <div id="auth-error" class="hidden text-red-400 text-sm bg-red-400/10 p-3 rounded-lg border border-red-400/20"></div>

                    <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg shadow-lg shadow-blue-500/20 transition-all active:scale-[0.98]">
                        Sign In
                    </button>
                </form>

                <div class="mt-6 flex flex-col gap-3">
                    <button id="toggle-view" class="text-sm text-slate-400 hover:text-white transition-colors text-center">
                        Don't have an account? Sign Up
                    </button>
                    <div class="relative my-2">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-700"></span></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-[#1e293b] px-2 text-slate-500">Or continue with</span></div>
                    </div>
                    <button id="guest-access" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-all">
                        Guest Access
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat View -->
    <div id="chat-view" class="hidden h-screen flex flex-col md:flex-row overflow-hidden galaxy-bg">
        
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-72 bg-[#1e293b] border-r border-slate-700/50">
            <div class="p-6 flex items-center gap-3 border-b border-slate-700/50">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight">Chatlaxy Pro</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div class="flex items-center gap-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4 px-2">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span id="online-count-label">Online Players (0)</span>
                </div>
                <div id="user-list" class="space-y-1">
                    <!-- Users dynamically populated -->
                </div>
            </div>

            <div class="p-4 border-t border-slate-700/50 bg-slate-800/30">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="user-display-email" class="text-sm font-bold text-white truncate">Anonymous</p>
                        <p class="text-xs text-slate-500">Pro Member</p>
                    </div>
                </div>
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 text-sm transition-all font-medium">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="flex-1 flex flex-col relative">
            <!-- Mobile Header -->
            <header class="md:hidden p-4 bg-[#1e293b] border-b border-slate-700 flex justify-between items-center">
                <h1 class="text-lg font-bold text-white">Chatlaxy Pro</h1>
                <button id="mobile-logout"><i data-lucide="log-out" class="w-5 h-5 text-red-400"></i></button>
            </header>

            <!-- Messages List -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 custom-scrollbar">
                <!-- Messages dynamically populated -->
            </div>

            <!-- Input Bar -->
            <div class="p-4 md:p-6 bg-gradient-to-t from-[#0f172a] via-[#0f172a] to-transparent">
                <form id="message-form" class="max-w-4xl mx-auto flex items-center gap-3 bg-[#1e293b] p-2 rounded-2xl border border-slate-700 shadow-xl">
                    <input type="text" id="message-input" autocomplete="off"
                        class="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 px-4 py-2 outline-none"
                        placeholder="Type a message to the galaxy...">
                    <button type="submit" id="send-btn" disabled
                        class="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed p-3 rounded-xl transition-all active:scale-95">
                        <i data-lucide="send" class="w-5 h-5 text-white"></i>
                    </button>
                </form>
                <p class="text-[10px] text-center text-slate-600 mt-3 uppercase tracking-widest">
                    Chatlaxy Pro Encrypted Connection
                </p>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            setDoc 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- SAFE INITIALIZATION ---
        window.onload = async function() {
            
            // Set the manual API key provided by the user
            const manualApiKey = "AIzaSyDncManQICLPVT8WuMVO5kB-Am32VI12wo";
            
            let firebaseConfig;
            try {
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    // Ensure the manual key is used even if config is provided
                    firebaseConfig.apiKey = manualApiKey;
                } else {
                    // Fallback configuration if the environment variable is missing
                    firebaseConfig = { 
                        apiKey: manualApiKey, 
                        authDomain: "chatlaxy-pro.firebaseapp.com", 
                        projectId: "chatlaxy-pro",
                        storageBucket: "chatlaxy-pro.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdef"
                    };
                }
            } catch (e) {
                console.error("Config parse error:", e);
                document.body.innerHTML = '<div class="h-screen flex items-center justify-center text-red-500 p-8 text-center">Failed to load configuration. Please refresh the page.</div>';
                return;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'chatlaxy-pro-v2';

            // --- DOM Selectors ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const authView = document.getElementById('auth-view');
            const chatView = document.getElementById('chat-view');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const toggleViewBtn = document.getElementById('toggle-view');
            const authError = document.getElementById('auth-error');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const messagesContainer = document.getElementById('messages-container');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const userListContainer = document.getElementById('user-list');
            const onlineCountLabel = document.getElementById('online-count-label');
            const userDisplayEmail = document.getElementById('user-display-email');
            const sendBtn = document.getElementById('send-btn');

            let currentUser = null;
            let currentView = 'login';

            const renderIcons = () => lucide.createIcons();

            // --- Auth Logic ---
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                loadingOverlay.classList.add('hidden');
                
                if (user) {
                    authView.classList.add('hidden');
                    chatView.classList.remove('hidden');
                    userDisplayEmail.textContent = user.email || 'Anonymous';
                    updatePresence(user);
                    startSubscriptions(user);
                } else {
                    authView.classList.remove('hidden');
                    chatView.classList.add('hidden');
                }
                renderIcons();
            });

            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                } catch (err) {
                    console.error("Auth init error:", err);
                }
            };

            const updatePresence = async (user) => {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                await setDoc(userRef, {
                    uid: user.uid,
                    email: user.email || 'Anonymous',
                    lastSeen: serverTimestamp(),
                    online: true
                }, { merge: true });
            };

            const startSubscriptions = (user) => {
                // Messages
                const messagesQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'));
                onSnapshot(messagesQuery, (snapshot) => {
                    const messages = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    renderMessages(messages, user);
                }, (err) => console.error("Firestore error:", err));

                // Users
                const usersQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                onSnapshot(usersQuery, (snapshot) => {
                    const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers(users);
                }, (err) => console.error("User list error:", err));
            };

            const renderMessages = (messages, user) => {
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                            <i data-lucide="message-square" class="w-12 h-12 opacity-20"></i>
                            <p class="text-sm">No messages yet. Start the conversation!</p>
                        </div>`;
                    renderIcons();
                    return;
                }

                messagesContainer.innerHTML = messages.map(msg => {
                    const isOwn = msg.uid === user.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    const emailLabel = msg.email ? msg.email.split('@')[0] : 'Anonymous';
                    return `
                        <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} animate-msg">
                            <div class="max-w-[85%] md:max-w-[70%] group">
                                <div class="flex items-center gap-2 mb-1 px-1 ${isOwn ? 'flex-row-reverse' : ''}">
                                    <span class="text-xs font-semibold text-slate-500">${emailLabel}</span>
                                    <span class="text-[10px] text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity">${time}</span>
                                </div>
                                <div class="px-4 py-2 rounded-2xl shadow-sm text-sm ${isOwn ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-[#1e293b] text-slate-200 border border-slate-700 rounded-tl-none'}">
                                    ${msg.text}
                                </div>
                            </div>
                        </div>`;
                }).join('');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            const renderUsers = (users) => {
                onlineCountLabel.textContent = `Online Players (${users.length})`;
                userListContainer.innerHTML = users.map(u => {
                    const initial = (u.email || 'A')[0].toUpperCase();
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 transition-colors group">
                            <div class="relative">
                                <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-xs font-bold uppercase">${initial}</div>
                                <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-[#1e293b] rounded-full"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-slate-300 truncate">${u.email.split('@')[0]}</p>
                            </div>
                        </div>`;
                }).join('');
            };

            // --- Form Handlers ---
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                authError.classList.add('hidden');
                try {
                    if (currentView === 'login') {
                        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    } else {
                        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    }
                } catch (err) {
                    authError.textContent = err.message.replace('Firebase:', '').trim();
                    authError.classList.remove('hidden');
                }
            });

            toggleViewBtn.addEventListener('click', () => {
                currentView = currentView === 'login' ? 'signup' : 'login';
                authTitle.textContent = currentView === 'login' ? 'Welcome Back' : 'Create Account';
                authSubmitBtn.textContent = currentView === 'login' ? 'Sign In' : 'Create Pro Account';
                toggleViewBtn.textContent = currentView === 'login' ? "Don't have an account? Sign Up" : "Already a member? Login";
            });

            document.getElementById('guest-access').addEventListener('click', () => signInAnonymously(auth));
            
            const logout = () => signOut(auth);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('mobile-logout').addEventListener('click', logout);

            messageInput.addEventListener('input', () => { sendBtn.disabled = !messageInput.value.trim(); });
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (!text || !currentUser) return;
                messageInput.value = '';
                sendBtn.disabled = true;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text,
                    uid: currentUser.uid,
                    email: currentUser.email,
                    timestamp: serverTimestamp()
                });
            });

            await initAuth();
        };
    </script>
</body>
</html>
