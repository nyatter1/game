<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlaxy Pro | Terminal v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap');

        :root {
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --bg-deep: #020617;
            --panel-glass: rgba(15, 23, 42, 0.8);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        /* --- Cyberpunk UI Elements --- */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            z-index: 99;
            opacity: 0.4;
        }

        .glass-panel {
            background: var(--panel-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .btn-cyber {
            position: relative;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 0.1em;
        }

        .btn-cyber:hover {
            transform: translateY(-2px);
            filter: brightness(1.2);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        /* --- Advanced Backgrounds --- */
        .bg-nebula {
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
        }
        .bg-matrix {
            background: linear-gradient(180deg, #020617 0%, #064e3b 100%);
        }
        .bg-blood {
            background: radial-gradient(circle at top, #450a0a 0%, #020617 100%);
        }

        /* --- Scrollbars --- */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- Message Animations --- */
        @keyframes msg-slide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .msg-anim { animation: msg-slide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* --- User Visual FX --- */
        .fx-glitch { animation: glitch 1s linear infinite; }
        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }

        .fx-rainbow {
            background: linear-gradient(to right, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6, #ef4444);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 3s linear infinite;
        }
        @keyframes rainbow { to { background-position: 200% center; } }

        .fx-neon { text-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent); }

        /* Fonts */
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-grotesk { font-family: 'Space Grotesk', sans-serif; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-nebula" id="app-root">
    <div class="crt-overlay"></div>

    <!-- Initialization / Syncing -->
    <div id="loader" class="fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center">
        <div class="relative w-32 h-32">
            <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
            <div class="absolute inset-4 border-2 border-slate-800 rounded-full flex items-center justify-center">
                <i data-lucide="shield-check" class="w-8 h-8 text-blue-500 animate-pulse"></i>
            </div>
        </div>
        <p class="mt-8 font-orbitron text-[10px] tracking-[0.5em] text-blue-500 animate-pulse">HANDSHAKING PROTOCOLS...</p>
    </div>

    <!-- Auth View -->
    <div id="auth-view" class="hidden min-h-screen flex items-center justify-center p-4 relative">
        <div class="w-full max-w-4xl glass-panel relative z-10 grid md:grid-cols-2 overflow-hidden border-t-4 border-blue-600">
            <!-- Form Side -->
            <div class="p-10 space-y-8">
                <div>
                    <h1 class="font-orbitron text-4xl font-black text-white italic tracking-tighter">CHATLAXY<span class="text-blue-500">PRO</span></h1>
                    <p class="text-[10px] font-mono text-slate-500 mt-2 uppercase tracking-widest">Global Encryption Node v4.0.2</p>
                </div>

                <div id="auth-tabs" class="flex border-b border-slate-800">
                    <button id="btn-tab-login" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-blue-500 border-b-2 border-blue-500">Login</button>
                    <button id="btn-tab-signup" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-500">Register</button>
                </div>

                <form id="auth-form" class="space-y-4">
                    <div id="signup-extra" class="hidden space-y-4">
                        <div class="group relative">
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block">Operator Alias</label>
                            <input type="text" id="reg-username" placeholder="NEO_ARCHITECT" class="w-full bg-slate-900/50 border border-slate-800 px-4 py-3 text-sm focus:border-blue-500 outline-none transition-all">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block">Comm ID (Email)</label>
                            <input type="email" id="auth-email" required placeholder="name@terminal.net" class="w-full bg-slate-900/50 border border-slate-800 px-4 py-3 text-sm focus:border-blue-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block">Access Key (Password)</label>
                            <input type="password" id="auth-pass" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-slate-900/50 border border-slate-800 px-4 py-3 text-sm focus:border-blue-500 outline-none transition-all">
                        </div>
                    </div>

                    <div id="auth-error" class="hidden text-red-500 text-[10px] bg-red-500/10 p-3 border-l-2 border-red-500 font-mono"></div>

                    <button type="submit" class="w-full btn-cyber bg-blue-600 py-4 text-xs">Establish Link</button>
                </form>

                <div class="flex items-center gap-4 py-2">
                    <div class="h-[1px] flex-1 bg-slate-800"></div>
                    <span class="text-[8px] font-bold text-slate-600 uppercase">OR</span>
                    <div class="h-[1px] flex-1 bg-slate-800"></div>
                </div>

                <button id="guest-btn" class="w-full border border-slate-800 py-3 text-[10px] uppercase font-bold text-slate-400 hover:bg-slate-800/30 transition-all tracking-widest">
                    Temporary Guest Pass
                </button>
            </div>

            <!-- Customization Side (Preview) -->
            <div class="bg-black/60 p-10 hidden md:flex flex-col justify-between border-l border-slate-800">
                <div class="space-y-8">
                    <p class="text-[9px] font-black text-blue-500 uppercase tracking-[0.3em]">Identity Config</p>
                    
                    <div class="flex flex-col items-center gap-4">
                        <div class="relative group">
                            <div id="preview-pfp-container" class="w-24 h-24 rounded-full border-2 border-dashed border-slate-700 flex items-center justify-center overflow-hidden bg-slate-900">
                                <i data-lucide="user-plus" class="w-8 h-8 text-slate-700"></i>
                            </div>
                            <input type="file" id="pfp-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <div class="text-center">
                            <span id="preview-name" class="font-orbitron text-xl font-bold uppercase tracking-tight text-white">OPERATOR_X</span>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <span class="px-2 py-0.5 bg-blue-500/10 text-blue-500 text-[8px] font-bold border border-blue-500/20 uppercase">Level 1</span>
                                <span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-[8px] font-bold uppercase">Recruit</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[8px] font-bold text-slate-500 uppercase">Aura Color</label>
                            <input type="color" id="cfg-color" value="#3b82f6" class="w-full h-8 bg-transparent border-none cursor-pointer">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[8px] font-bold text-slate-500 uppercase">Visual Mod</label>
                            <select id="cfg-fx" class="w-full bg-slate-900 border border-slate-800 text-[9px] p-2 text-slate-300">
                                <option value="none">Standard</option>
                                <option value="fx-glitch">Glitch</option>
                                <option value="fx-rainbow">Spectrum</option>
                                <option value="fx-neon">Neon Glow</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-600/5 p-4 border border-blue-500/10 rounded">
                    <p class="text-[9px] text-blue-400/60 leading-relaxed font-mono">
                        "The interface is not just a tool; it's an extension of your digital consciousness. Choose your parameters wisely."
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-view" class="hidden h-screen flex flex-col md:flex-row overflow-hidden relative">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 glass-panel border-r border-slate-800/50 flex flex-col relative z-20">
            <div class="p-6 border-b border-slate-800/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
                    <span class="font-orbitron text-xs font-bold tracking-[0.2em] text-white">TERMINAL_NODES</span>
                </div>
                <button id="settings-toggle" class="p-2 hover:bg-slate-800 rounded transition-colors">
                    <i data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i>
                </button>
            </div>

            <!-- Stats/XP Bar -->
            <div class="px-6 py-4 bg-black/20 border-b border-slate-800/30">
                <div class="flex justify-between text-[8px] font-bold uppercase tracking-widest text-slate-500 mb-1">
                    <span>Experience / Rank</span>
                    <span id="rank-display">Lvl 1</span>
                </div>
                <div class="h-1 bg-slate-800 w-full overflow-hidden">
                    <div id="xp-progress" class="h-full bg-blue-500" style="width: 30%"></div>
                </div>
            </div>

            <!-- User Lists -->
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div class="mb-6">
                    <h3 class="text-[8px] font-black text-blue-500 uppercase tracking-[0.3em] px-2 mb-3">Online Operatives</h3>
                    <div id="user-list-online" class="space-y-1"></div>
                </div>
                <div>
                    <h3 class="text-[8px] font-black text-slate-600 uppercase tracking-[0.3em] px-2 mb-3">Disconnected</h3>
                    <div id="user-list-offline" class="space-y-1 opacity-50"></div>
                </div>
            </div>

            <!-- Current User Profile -->
            <div class="p-4 bg-black/40 border-t border-slate-800/50">
                <div class="flex items-center gap-3">
                    <div id="me-avatar" class="w-10 h-10 rounded-full border-2 border-slate-800 overflow-hidden bg-slate-900"></div>
                    <div class="flex-1 min-w-0">
                        <p id="me-name" class="text-xs font-black text-white uppercase truncate font-orbitron">Guest</p>
                        <p id="me-status" class="text-[8px] text-blue-500 font-bold uppercase">Online</p>
                    </div>
                    <button id="logout-btn" class="p-2 text-slate-500 hover:text-red-500 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Chat Container -->
        <main class="flex-1 flex flex-col relative z-10">
            <!-- Header -->
            <header class="h-16 glass-panel border-b border-slate-800/50 flex items-center justify-between px-6">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-blue-500 tracking-[0.2em] uppercase">Global Channel</span>
                    <span class="text-[8px] font-mono text-slate-500">SECURE_TUNNEL_ESTABLISHED: AES-256</span>
                </div>
                <div class="flex gap-2">
                    <button id="theme-nebula" class="w-4 h-4 rounded-full bg-indigo-900 border border-slate-700"></button>
                    <button id="theme-matrix" class="w-4 h-4 rounded-full bg-emerald-900 border border-slate-700"></button>
                    <button id="theme-blood" class="w-4 h-4 rounded-full bg-rose-950 border border-slate-700"></button>
                </div>
            </header>

            <!-- Messages Area -->
            <div id="message-container" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                <!-- Messages render here -->
            </div>

            <!-- Input Area -->
            <div class="p-6 relative">
                <div class="max-w-4xl mx-auto glass-panel p-1 border border-slate-700/50 rounded-lg group focus-within:border-blue-500/50 transition-all">
                    <form id="chat-form" class="flex items-center gap-2">
                        <button type="button" id="emoji-trigger" class="p-3 text-slate-500 hover:text-blue-500">
                            <i data-lucide="smile" class="w-5 h-5"></i>
                        </button>
                        <input type="text" id="chat-input" placeholder="Transmit data string..." autocomplete="off"
                            class="flex-1 bg-transparent border-none outline-none py-3 px-2 text-sm text-white font-grotesk placeholder:text-slate-600">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-md btn-cyber flex items-center gap-2">
                            <span class="text-[10px]">SEND</span>
                            <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
                
                <!-- Emoji Panel (Hidden) -->
                <div id="emoji-panel" class="hidden absolute bottom-24 left-6 p-4 glass-panel border border-slate-700 w-64 grid grid-cols-4 gap-2">
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ”¥</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸš€</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ’Ž</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ’€</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸŒŒ</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ‘¾</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ”‹</button>
                    <button class="emoji-btn hover:scale-125 transition-transform">ðŸ¦¾</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs, where, limit, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global State
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chatlaxy-pro-v4';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userState = {
            profile: null,
            auth: null,
            mode: 'login',
            theme: 'bg-nebula'
        };

        const el = (id) => document.getElementById(id);
        const refreshIcons = () => lucide.createIcons();

        // --- Audio System ---
        const playSfx = (type) => {
            const sounds = {
                'click': 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
                'msg': 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
                'login': 'https://assets.mixkit.co/active_storage/sfx/136/136-preview.mp3'
            };
            const audio = new Audio(sounds[type]);
            audio.volume = 0.2;
            audio.play().catch(() => {});
        };

        // --- Auth & Data Listeners ---
        onAuthStateChanged(auth, async (user) => {
            userState.auth = user;
            if (user) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    userState.profile = snap.data();
                } else {
                    // Fallback for guest or new auth
                    userState.profile = {
                        username: user.displayName || `OPERATOR_${Math.floor(Math.random()*9000 + 1000)}`,
                        color: '#3b82f6',
                        fx: 'none',
                        xp: 0,
                        pfp: null
                    };
                    await setDoc(docRef, { ...userState.profile, online: true }, { merge: true });
                }

                await updateDoc(docRef, { online: true, lastSeen: serverTimestamp() });
                
                el('loader').classList.add('hidden');
                el('auth-view').classList.add('hidden');
                el('main-view').classList.remove('hidden');
                initAppUI();
                startDataSubscriptions();
                playSfx('login');
            } else {
                el('loader').classList.add('hidden');
                el('auth-view').classList.remove('hidden');
                el('main-view').classList.add('hidden');
            }
            refreshIcons();
        });

        // --- UI Initialization ---
        function initAppUI() {
            const p = userState.profile;
            el('me-name').textContent = p.username;
            el('me-name').style.color = p.color;
            el('me-avatar').innerHTML = p.pfp ? `<img src="${p.pfp}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-500 font-bold">${p.username[0]}</div>`;
            el('me-avatar').style.borderColor = p.color;
            
            // Stats
            const level = Math.floor(Math.sqrt(p.xp / 100)) + 1;
            el('rank-display').textContent = `Lvl ${level}`;
            el('xp-progress').style.width = `${(p.xp % 100)}%`;
        }

        function startDataSubscriptions() {
            // Messages
            const msgQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), limit(50));
            onSnapshot(msgQuery, (snap) => {
                const messages = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                renderMessages(messages);
            }, (err) => console.error(err));

            // Users
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                const users = snap.docs.map(d => d.data());
                renderUserList(users);
            });
        }

        // --- Rendering ---
        function renderMessages(messages) {
            const container = el('message-container');
            container.innerHTML = messages.map((m, i) => {
                const isMe = m.uid === userState.auth.uid;
                const time = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                
                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} msg-anim" style="animation-delay: ${i * 0.05}s">
                    <div class="flex gap-4 max-w-[80%] ${isMe ? 'flex-row-reverse' : ''}">
                        <div class="w-10 h-10 rounded-full flex-shrink-0 border-2 bg-slate-900 overflow-hidden ${m.fx || ''}" style="border-color: ${m.color || '#334155'}">
                            ${m.pfp ? `<img src="${m.pfp}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] text-slate-500 font-bold">${m.username[0]}</div>`}
                        </div>
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-black uppercase tracking-widest ${m.fx || ''}" style="color: ${m.color || '#64748b'}">${m.username}</span>
                                <span class="text-[8px] text-slate-600 font-mono">${time}</span>
                            </div>
                            <div class="px-5 py-3 rounded-2xl glass-panel text-sm font-grotesk leading-relaxed ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'} border border-slate-700/50" 
                                 style="border-left: 4px solid ${m.color || '#3b82f6'};">
                                ${m.text}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
            if(messages.length > 0) playSfx('msg');
        }

        function renderUserList(users) {
            const online = users.filter(u => u.online);
            const offline = users.filter(u => !u.online);

            const tpl = (u) => `
                <div class="flex items-center gap-3 p-2 hover:bg-white/5 transition-all rounded-lg group cursor-pointer">
                    <div class="w-8 h-8 rounded-full border-2 bg-slate-900 overflow-hidden ${u.fx || ''}" style="border-color: ${u.color || '#1e293b'}">
                        ${u.pfp ? `<img src="${u.pfp}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[8px] text-slate-500">${u.username[0]}</div>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold uppercase truncate tracking-tighter ${u.fx || ''}" style="color: ${u.color || '#64748b'}">${u.username}</p>
                        <p class="text-[8px] text-slate-500 font-mono">ID: ${u.uid.slice(0,6)}</p>
                    </div>
                    ${u.online ? '<div class="w-1 h-1 rounded-full bg-blue-500 shadow-[0_0_5px_#3b82f6]"></div>' : ''}
                </div>`;

            el('user-list-online').innerHTML = online.map(tpl).join('');
            el('user-list-offline').innerHTML = offline.map(tpl).join('');
        }

        // --- Interaction Handlers ---
        el('auth-tabs').addEventListener('click', (e) => {
            const isSignup = e.target.id === 'btn-tab-signup';
            userState.mode = isSignup ? 'signup' : 'login';
            
            el('signup-extra').classList.toggle('hidden', !isSignup);
            el('btn-tab-signup').classList.toggle('text-blue-500', isSignup);
            el('btn-tab-signup').classList.toggle('border-blue-500', isSignup);
            el('btn-tab-login').classList.toggle('text-blue-500', !isSignup);
            el('btn-tab-login').classList.toggle('border-blue-500', !isSignup);
            el('btn-tab-login').classList.toggle('text-slate-500', isSignup);
            el('btn-tab-signup').classList.toggle('text-slate-500', !isSignup);
            playSfx('click');
        });

        el('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = el('auth-email').value;
            const pass = el('auth-pass').value;
            el('auth-error').classList.add('hidden');

            try {
                if (userState.mode === 'signup') {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    const profile = {
                        uid: cred.user.uid,
                        username: el('reg-username').value || 'OPERATOR_X',
                        color: el('cfg-color').value,
                        fx: el('cfg-fx').value,
                        xp: 10,
                        pfp: userState.profile?.pfp || null,
                        online: true,
                        lastSeen: serverTimestamp()
                    };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', cred.user.uid), profile);
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                el('auth-error').textContent = err.message;
                el('auth-error').classList.remove('hidden');
            }
        });

        el('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = el('chat-input').value.trim();
            if(!text || !userState.auth) return;
            
            el('chat-input').value = '';
            
            const msg = {
                text,
                uid: userState.auth.uid,
                username: userState.profile.username,
                color: userState.profile.color,
                fx: userState.profile.fx,
                pfp: userState.profile.pfp,
                timestamp: serverTimestamp()
            };

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), msg);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userState.auth.uid), { xp: increment(2) });
        });

        // Preview Logic
        el('reg-username').addEventListener('input', (e) => el('preview-name').textContent = e.target.value || 'OPERATOR_X');
        el('cfg-color').addEventListener('input', (e) => {
            el('preview-name').style.color = e.target.value;
            document.documentElement.style.setProperty('--accent', e.target.value);
        });
        el('cfg-fx').addEventListener('change', (e) => el('preview-name').className = `font-orbitron text-xl font-bold uppercase tracking-tight text-white ${e.target.value}`);

        el('pfp-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const data = ev.target.result;
                    if(!userState.profile) userState.profile = {};
                    userState.profile.pfp = data;
                    el('preview-pfp-container').innerHTML = `<img src="${data}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Themes
        ['nebula', 'matrix', 'blood'].forEach(t => {
            el(`theme-${t}`).addEventListener('click', () => {
                const root = el('app-root');
                root.classList.remove('bg-nebula', 'bg-matrix', 'bg-blood');
                root.classList.add(`bg-${t}`);
                playSfx('click');
            });
        });

        el('guest-btn').addEventListener('click', () => signInAnonymously(auth));
        el('logout-btn').addEventListener('click', () => {
            if(userState.auth) updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userState.auth.uid), { online: false });
            signOut(auth);
        });
        
        el('emoji-trigger').addEventListener('click', () => el('emoji-panel').classList.toggle('hidden'));
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                el('chat-input').value += btn.textContent;
                el('emoji-panel').classList.add('hidden');
                el('chat-input').focus();
            });
        });

        refreshIcons();
    </script>
</body>
</html>
